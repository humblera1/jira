# Настройка Jira с использованием Docker Compose

Этот документ предоставляет инструкции по настройке и запуску Jira с использованием `docker compose`.

## Предварительные требования

- Docker и Docker Compose должны быть установлены на вашей системе.
- Для установки Docker и Docker Compose на CentOS 7, следуйте инструкциям в файле [docker-setup.md](./docker-setup.md).
- Проверьте, что Docker и Docker Compose установлены, выполнив следующие команды:
  ```bash
  docker --version
  docker compose --version

## Настройка переменных окружения

1. Скопируйте файл `.env.example` и переименуйте его в `.env`:
   ```bash
   cp .env.example .env
   ```
2. Откройте файл `.env` и настройте следующие переменные окружения:

- `MYSQL_HOST`: Имя хоста для сервиса MySQL.
- `MYSQL_ROOT_PASSWORD`: Пароль root для базы данных MySQL.
- `JIRA_DB_NAME`: Имя базы данных Jira.
- `JIRA_DB_USER`: Имя пользователя для базы данных Jira.
- `JIRA_DB_PASSWORD`: Пароль для пользователя базы данных Jira.
- `EXTERNAL_PORT`: Внешний порт для доступа к Jira (по умолчанию 8181).

## Сервисы

### MySQL

- **Образ**: `mysql:8.0`
- **Переменные окружения**: Настроены для использования предоставленных переменных окружения для настройки базы данных.
- **Тома**: Данные сохраняются в томе Docker с именем `mysql-data`.
- **Сеть**: Подключен к сети Docker с именем `web`.

### Jira

- **Контекст сборки**: Использует Dockerfile в текущей директории для сборки образа Jira.
- **Переменные окружения**: Настроены для подключения к базе данных MySQL и настройки домашней директории Jira.
- **Порты**: Внутренне открывает порт 8080, сопоставленный с `${EXTERNAL_PORT}` внешне.
- **Тома**: Данные сохраняются в томе Docker с именем `jira-data`.
- **Зависимости**: Необходимо, чтобы сервис MySQL был запущен.
- **Сеть**: Подключен к той же сети `web`.

В образе для данного контейнера также происходит установка коннектора `./mysql-connector/mysql-connector-j_8.1.0-1ubuntu22.04_all.deb`, который используется для подключения к базе данных.

Помимо этого, происходит копирование `./crack/atlassian-agent.jar` в контейнер, который в дальнейшем используется для генерации лицензионного ключа.

## Тома

- `mysql-data`: Сохраняет данные MySQL.
- `jira-data`: Сохраняет данные Jira.

## Сети

- `web`: Сетевой мост, который позволяет общение между сервисами MySQL и Jira.

## Запуск приложения

1. Убедитесь, что все необходимые переменные окружения установлены.
2. Выполните следующую команду для запуска сервисов:
   ```bash
   docker compose up -d
   ```
3. Доступ к Jira можно получить, перейдя по адресу `http://localhost:${EXTERNAL_PORT}` в вашем веб-браузере.

## Генерация ключа

В процессе настройки сервиса Jira может потребоваться сгенерировать лицензионный ключ. Для этого используется `atlassian-agent.jar`, помещенный в контейнер с Jira.

Для генерации необходимо подключиться к контейнеру и использовать описанный файл. Вы можете воспользоваться следующим шаблоном команды:

   ```bash
   docker exec -it jira java -jar /opt/atlassian/jira/atlassian-agent.jar -d -m [your-email] -n BAT -p jira -o [host] -s [server-id]
   ```

## Остановка приложения

Чтобы остановить сервисы, выполните:
```bash
docker compose down
```

Это остановит и удалит контейнеры, но данные будут сохранены в томах Docker.

## Конфигурация NGINX

Для обеспечения доступа к Jira по доменному имени необходимо настроить NGINX в качестве прокси. Конфигурация для домена `jira.niistrom.pro` приведена в [jira.conf](./jira.conf).

## Устранение неполадок

- Убедитесь, что переменные окружения правильно установлены.
- Проверьте логи Docker на наличие ошибок, используя:
  ```bash
  docker compose logs
  ```

Эта настройка предоставляет простой способ запуска Jira с базой данных MySQL с использованием Docker. Настройте переменные окружения и конфигурации в соответствии с вашими конкретными требованиями.